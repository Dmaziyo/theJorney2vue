<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ideal</title>
  </head>
  <body>
    <div id="test">
      <p>{{msg}}</p>
      <p>{{msg}}</p>
      <p>{{what}}</p>
      <p>{{hey}}</p>
    </div>
    <script>
      // 将包含mustache syntax的el标记
      let bindingMark = 'data-element-binding'
      // 旧版的Class写法
      function Element(id, initData) {
        let self = this
        // 获取vue实例
        el = self.el = document.getElementById(id)
        // mustache的元素集合
        bindings = {}
        data = self.data = {}
        content = el.innerHTML.replace(/\{\{(.*)\}\}/g, markToken)
        el.innerHTML = content
        // 从先前mark至bindings获取属性名
        for (let variable in bindings) {
          bind(variable)
        }

        // 即给msg赋值初始化了
        if (initData) {
          for (let variable in initData) {
            data[variable] = initData[variable]
          }
        }

        // 把mustache包含的变量全部转换成span
        //{{msg}} => <span data-element-binding="msg"></span>
        function markToken(match, variable) {
          bindings[variable] = {}
          return `<span ${bindingMark}="${variable}"></span>`
        }

        function bind(variable) {
          //bingds[msg].els = 所有在mustache中使用msg作为变量的元素
          bindings[variable].els = el.querySelectorAll(
            `[${bindingMark}="${variable}"]`
          )
          ;[].forEach.call(bindings[variable].els, function (e) {
            console.log(e)
            e.removeAttribute(bindingMark)
          })
          // 给data添加msg属性，并且设置set在改变值的同时改变当前el的值
          Object.defineProperty(data, variable, {
            set: function (newVal) {
              ;[].forEach.call(bindings[variable].els, function (e) {
                // 赋值给data易于打印出来
                bindings[variable].value = e.textContent = newVal
              })
            },
            get: function () {
              return bindings[variable].value
            }
          })
        }
      }

      let app = new Element('test', {
        msg: 'hello World',
        what: 'wtf?',
        hey: '123'
      })
    </script>
  </body>
</html>
